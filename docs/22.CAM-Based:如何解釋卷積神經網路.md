# [Day 22] CAM-Basedï¼šå¦‚ä½•è§£é‡‹å·ç©ç¥ç¶“ç¶²è·¯
CAMï¼ˆClass Activation Mappingï¼‰æ˜¯ä¸€ç¨®ç”¨æ–¼è§£é‡‹å·ç©ç¥ç¶“ç¶²è·¯ï¼ˆCNNï¼‰æ¨¡å‹åœ¨åœ–åƒåˆ†é¡ä»»å‹™ä¸­çš„é æ¸¬çš„æŠ€è¡“ã€‚å®ƒçš„ç›®çš„æ˜¯ç”Ÿæˆä¸€å€‹è¦–è¦ºåŒ–çš„ç†±åœ–ï¼Œä»¥é¡¯ç¤ºæ¨¡å‹åœ¨åœ–åƒä¸­é—œæ³¨çš„å€åŸŸï¼Œä»¥åŠé€™äº›å€åŸŸå°æ–¼æ¨¡å‹é æ¸¬æŸä¸€é¡åˆ¥çš„è²¢ç»ã€‚ä»¥ä¸‹æ˜¯è¿‘å¹´ä¾†èˆ‡ CAM ç›¸é—œçš„è®Šå½¢æ–¹æ³•çš„æ•´ç†ï¼š

- [CAM (Class Activation Mapping)](https://arxiv.org/abs/1512.04150) (Zhou et al. 2015):
åŸºæœ¬çš„CAMæ–¹æ³•æ˜¯ç”¨ä¾†è§£é‡‹CNNæ¨¡å‹çš„é æ¸¬ï¼Œé€šéå°‡å·ç©å±¤çš„ç‰¹å¾µåœ–èˆ‡å…¨é€£æ¥å±¤çš„æ¬Šé‡ç›¸çµåˆï¼Œç”Ÿæˆé¡åˆ¥ç‰¹å®šçš„ç†±åœ–ï¼Œä»¥é¡¯ç¤ºæ¨¡å‹å°æ–¼ä¸åŒé¡åˆ¥çš„æ³¨æ„åŠ›åˆ†ä½ˆã€‚
- [Grad-CAM (Gradient-weighted Class Activation Mapping)](https://arxiv.org/abs/1610.02391) (Ancona et al. 2016):
Grad-CAMå»ºç«‹åœ¨CAMçš„åŸºç¤ä¸Šï¼Œä½¿ç”¨æ¢¯åº¦è¨Šæ¯ä¾†æ›´æº–ç¢ºåœ°è¨ˆç®—ç‰¹å¾µåœ–ä¸Šçš„æ¬Šé‡ã€‚å®ƒé€šéå°‡å·ç©å±¤çš„æ¢¯åº¦å€¼èˆ‡ç‰¹å¾µåœ–ç›¸ä¹˜ï¼Œç”Ÿæˆç†±åœ–ï¼Œä»¥è¦–è¦ºåŒ–æ¨¡å‹å°æ–¼ä¸åŒé¡åˆ¥çš„é—œæ³¨é»ã€‚
- [Grad-CAM++](https://arxiv.org/abs/1710.11063) (Chattopadhyay et al. 2017):
Grad-CAM++æ˜¯Grad-CAMçš„é€²ä¸€æ­¥æ”¹é€²ç‰ˆæœ¬ï¼Œå®ƒå¼•å…¥äº†å¤šå°ºåº¦ç‰¹å¾µåœ–çš„æ¦‚å¿µï¼Œä»¥æé«˜å°æ–¼ç´°å¾®ç´°ç¯€çš„è§£é‡‹èƒ½åŠ›ã€‚å®ƒä½¿ç”¨å¤šå€‹å·ç©å±¤çš„ç‰¹å¾µåœ–ä¾†ç”Ÿæˆæ›´å…·ç´°ç¯€çš„ç†±åœ–ã€‚
- [Score-CAM](https://arxiv.org/abs/1910.01279) (Haofan et al. 2020):
Score-CAMæ˜¯ä¸€ç¨®ç”¨æ–¼è§£é‡‹æ¨¡å‹é æ¸¬çš„æ–¹æ³•ï¼Œå®ƒé€šéå°‡é€šé“çš„åˆ†æ•¸ï¼ˆscoreï¼‰å’Œç‰¹å¾µåœ–ç›¸ä¹˜ï¼Œç”Ÿæˆé¡åˆ¥ç‰¹å®šçš„ç†±åœ–ã€‚å®ƒæ—¨åœ¨æé«˜CAMæ–¹æ³•çš„æ€§èƒ½ï¼Œä¸¦æ¸›å°‘å™ªè²ã€‚

åœ¨ä»Šå¤©çš„å…§å®¹ä¸­ï¼Œå°‡ä»‹ç´¹ CAM å’Œ Grad-CAM çš„å·®åˆ¥ï¼Œæœ€å¾Œä½¿ç”¨ TensorFlow ä¾†ç¤ºç¯„å¦‚ä½•é‹ç”¨ Grad-CAM æ–¹æ³•ä¾†è§£é‡‹ CNN æ¨¡å‹ã€‚

## CAM
CAM åœ¨ 2015 å¹´è¢«æå‡ºï¼Œè«–æ–‡åç¨±ç‚º [Learning Deep Features for Discriminative Localization](https://arxiv.org/abs/1512.04150)ï¼Œå®ƒçš„ä¸»è¦æ¦‚å¿µæ˜¯å°‡ CNN çš„æœ€å¾Œä¸€å€‹å·ç©å±¤çš„ç‰¹å¾µåœ–ä¹‹å¾Œæ¥ä¸Šå…¨å±€å¹³å‡æ± åŒ–å±¤(Global Average Pooling Layer)èˆ‡å…¨é€£æ¥å±¤çš„æ¬Šé‡ç›¸çµåˆã€‚é¦–å…ˆè¨ˆç®—æ¯å€‹é¡åˆ¥çš„æ¬Šé‡ï¼Œé€™äº›æ¬Šé‡æ˜¯å…¨é€£æ¥å±¤çš„æ¬Šé‡èˆ‡å·ç©å±¤çš„ç‰¹å¾µåœ–ç›¸ä¹˜å¾Œçš„ç¸½å’Œã€‚æ¥è‘—å°‡é€™äº›æ¬Šé‡æ‡‰ç”¨åˆ°å·ç©å±¤çš„ç‰¹å¾µåœ–ä¸Šï¼Œç”Ÿæˆä¸€å€‹é¡åˆ¥ç‰¹å®šçš„ç†±åœ–ã€‚é€™å€‹ç†±åœ–é¡¯ç¤ºäº†å°æ–¼æŸä¸€ç‰¹å®šé¡åˆ¥ï¼Œåœ–åƒçš„ä¸åŒå€åŸŸçš„ç›¸å°é‡è¦æ€§ã€‚æœ€å¾Œç†±åœ–ç¶“éé©ç•¶çš„æ­£è¦åŒ–è™•ç†ï¼Œä»¥ç¢ºä¿å®ƒå¯ä»¥è¢«è¦–è¦ºåŒ–ä¸¦èˆ‡åŸå§‹åœ–åƒå°ºå¯¸å°æ‡‰ã€‚

![](./image/img22-1.png)

å…¨å±€å¹³å‡æ± åŒ–ï¼ˆGlobal Average Poolingï¼‰æ˜¯ä¸€ç¨®ç”¨æ–¼å·ç©ç¥ç¶“ç¶²è·¯ï¼ˆCNNï¼‰ä¸­çš„ç‰¹å¾µæ˜ å°„çš„æ“ä½œã€‚å®ƒé€šå¸¸ç”¨æ–¼å·ç©ç¥ç¶“ç¶²è·¯çš„æœ€å¾Œä¸€å±¤ï¼Œä»¥å¹«åŠ©ç¸®æ¸›ç‰¹å¾µåœ–çš„ç¶­åº¦ä¸¦ç”Ÿæˆä¸€å€‹å›ºå®šå¤§å°çš„è¼¸å‡ºï¼Œä»¥ä¾›å¾ŒçºŒçš„åˆ†é¡æˆ–å›æ­¸ä»»å‹™ä½¿ç”¨ã€‚å…¨å±€å¹³å‡æ± åŒ–çš„éç¨‹éå¸¸ç°¡å–®ï¼Œä»¥ä¸‹ç”¨ä¸€å¼µç‰¹å¾µåœ–ç‚ºä¾‹ï¼Œå‡è¨­ pool size 4*4 ä¹Ÿå°±æ˜¯å°æ•´å¼µåœ–åšå¹³å‡å¾—åˆ° 24 é€™å°±æ˜¯ä¸€å€‹é€šé“(ä¸€å¼µç‰¹å¾µåœ–) GAP å¾Œçš„çµæœã€‚

![](./image/img22-2.png)

ç°¡å–®ä¾†èªªå…¨å±€å¹³å‡æ± åŒ–åšæ³•å±¬æ–¼ç©ºé–“ç¶­åº¦çš„ä¸€ç¨®ç‰¹å¾µå£“ç¸®ï¼Œå› ç‚ºé€™å€‹å¯¦æ•¸æ˜¯æ ¹æ“šæ‰€æœ‰ç‰¹å¾µå€¼è¨ˆç®—å‡ºä¾†çš„ï¼Œæ‰€ä»¥åœ¨æŸç¨®ç¨‹åº¦ä¸Šå…·æœ‰å¹³å‡æ„Ÿå—é‡ï¼Œæœ€å¾Œä¿æŒé€šé“æ•¸ä¸è®Šï¼Œæ‰€ä»¥æœ€å¾Œè¼¸å‡ºå¤§å°ç‚º 1x1xCï¼š

![](./image/img22-3.png)

ç¶“éå…¨å±€å¹³å‡æ± åŒ–ï¼ˆGAPï¼‰å¾Œï¼Œæˆ‘å€‘å¾—åˆ°äº†ä¸€å€‹åŒ…å«æ¬Šé‡ w çš„åƒç´ é™£åˆ—ã€‚é€™äº›æ¬Šé‡ w åæ˜ äº†æ¯å¼µç‰¹å¾µåœ–å°æ–¼æœ€çµ‚é æ¸¬æŸå€‹é¡åˆ¥çš„é‡è¦æ€§ã€‚æ›´å¤§çš„æ¬Šé‡å€¼è¡¨ç¤ºç›¸æ‡‰ç‰¹å¾µåœ–å°æ–¼è©²åˆ†é¡çš„è²¢ç»æ›´å¤§ã€‚

![](./image/img22-4.png)

ç‚ºäº†æ›´å¥½åœ°ç†è§£é€™äº›æ¬Šé‡ï¼Œæˆ‘å€‘å¯ä»¥å°‡å®ƒå€‘æ‡‰ç”¨æ–¼æ•´å¼µç‰¹å¾µåœ–ä¸Šçš„æ¯å€‹åƒç´ é»ï¼Œç„¶å¾Œé€²è¡Œç–ŠåŠ ã€‚é€™æ¨£åšçš„å¥½è™•æ˜¯æˆ‘å€‘å¯ä»¥æ ¹æ“šæ¯å¼µç‰¹å¾µåœ–çš„é‡è¦æ€§ä¾†é›†ä¸­é—œæ³¨ä¸åŒçš„å€åŸŸã€‚å¦‚æœæŸç‰¹å®šåˆ†é¡çš„æ¬Šé‡ w å¾ˆå¤§ï¼Œé‚£éº¼è©²åˆ†é¡æ‰€å°æ‡‰çš„ç‰¹å¾µåœ–å°‡åœ¨é€²è¡Œç–ŠåŠ æ™‚å…·æœ‰æ›´å¤§çš„å½±éŸ¿ã€‚ç›¸åï¼Œæ¬Šé‡æ¥è¿‘æ–¼0çš„ç‰¹å¾µåœ–å°æ–¼æœ€çµ‚çš„é—œæ³¨åº¦è¼ƒä½ï¼Œå› æ­¤å®ƒå€‘è¢«è¦–ç‚ºä¸å¤ªé‡è¦çš„éƒ¨åˆ†ã€‚

![](./image/img22-5.png)

æ­¤æ–¹æ³•ç¢ºå¯¦ç‚ºè§£é‡‹ CNN æ¨¡å‹çš„é æ¸¬æä¾›äº†é‡è¦çš„åŸºç¤ï¼Œä½†å®ƒå­˜åœ¨ä¸€å€‹æ˜é¡¯çš„é™åˆ¶ï¼Œå³å—åˆ°äº†ç¶²è·¯æ¶æ§‹çš„é™åˆ¶ã€‚å› ç‚ºå¦‚æœè¦ä½¿ç”¨ CAM è§£é‡‹ï¼Œåœ¨ CNN æ¶æ§‹ç•¶ä¸­æœ€å¾Œä¸€å±¤ä¸€å®šè¦æ¥ä¸Š GAP å±¤ã€‚éš¨å¾Œçš„æ–¹æ³•ï¼Œå¦‚Grad-CAMå’Œå…¶è®Šç¨®ï¼Œè©¦åœ–å…‹æœé€™äº›é™åˆ¶ï¼Œä½¿è§£é‡‹æ€§æ–¹æ³•æ›´å…·é€šç”¨æ€§ï¼Œé©ç”¨æ–¼å„ç¨®æ·±åº¦å­¸ç¿’æ¨¡å‹ã€‚



## Grad-CAM
å¾ CAM çš„ä»‹ç´¹ä¸­ï¼Œæˆ‘å€‘äº†è§£åˆ°å¯¦ç¾ CAM æ‰€éœ€çš„ä¸€å€‹é—œéµæ¢ä»¶æ˜¯å¿…é ˆåŠ å…¥å…¨å±€å¹³å‡æ± åŒ–ï¼ˆGAPï¼‰å±¤ã€‚ç„¶è€Œé€™ç¨®è¦æ±‚åœ¨æŸç¨®ç¨‹åº¦ä¸Šé™åˆ¶äº†ç¶²è·¯æ¶æ§‹çš„è‡ªç”±åº¦ï¼Œå› ç‚ºæ¨¡å‹å¿…é ˆåŒ…å« GAP å±¤æ‰èƒ½ä½¿ç”¨ CAMã€‚æ›´é‡è¦çš„æ˜¯ï¼Œå¦‚æœæˆ‘å€‘å …æŒè¦æ±‚æ¨¡å‹çš„æœ€å¾Œä¸€å±¤å¿…é ˆæ˜¯GAPå±¤ï¼Œé€™å¯èƒ½æœƒå½±éŸ¿æ¨¡å‹çš„æº–ç¢ºæ€§ã€‚å› æ­¤ Grad-CAM åœ¨é€™æ–¹é¢è§£é™¤äº†é€™ç¨®é™åˆ¶ï¼Œå®ƒå‡ºè‡ªæ–¼é€™é‚Šè«–æ–‡ [Grad-CAM: Visual Explanations from Deep Networks via Gradient-based Localization ](https://arxiv.org/abs/1610.02391)ã€‚ä½¿ç”¨ Grad-CAM æˆ‘å€‘å¯ä»¥å°ä¸€èˆ¬çš„ CNN æ¶æ§‹é€²è¡Œè§£é‡‹ï¼Œè€Œä¸éœ€è¦å¼·åˆ¶è¦æ±‚æ¨¡å‹çš„æœ€å¾Œä¸€å±¤å¿…é ˆæ˜¯ GAP å±¤ã€‚é€™æ„å‘³è‘—æˆ‘å€‘å¯ä»¥æ›´éˆæ´»åœ°æ‡‰ç”¨ Grad-CAM ä¾†ç²å¾— CNN å°è¼¸å…¥åœ–ç‰‡çš„é—œæ³¨å€åŸŸï¼Œè€Œç„¡éœ€å°æ¨¡å‹é€²è¡Œå¤§å¹…åº¦çš„ä¿®æ”¹ï¼ŒåŒæ™‚ä¸æœƒæ˜é¡¯å½±éŸ¿æ¨¡å‹çš„æº–ç¢ºæ€§ã€‚


å¾ä¸‹åœ–ä¸­å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°ï¼Œä¸è«–æ˜¯å…¨é€£æ¥å±¤ã€RNNã€LSTMï¼Œæˆ–è€…æ›´è¤‡é›œçš„ç¶²è·¯æ¨¡å‹ï¼Œéƒ½å¯ä»¥é€é Grad-CAM å–å¾—ç¥ç¶“ç¶²çµ¡çš„åˆ†é¡é—œæ³¨å€åŸŸç†±åŠ›åœ–ã€‚

![](./image/img22-6.png)


ç°¡å–®ä¾†èªª Grad-CAM çš„é—œéµåœ¨æ–¼èƒ½å¤ é€éåå‘å‚³æ’­è¨ˆç®—ç”¨æ–¼ CAM çš„æ¬Šé‡ ğ‘¤ã€‚æˆ‘å€‘å¯ä»¥é‡å°æ¯å€‹ç‰¹å¾µåœ–é€²è¡Œåå‘å‚³æ’­ï¼Œè¨ˆç®—æ¢¯åº¦çš„å¹³å‡å€¼ï¼Œä»¥ç²å¾—ç›¸å°æ‡‰çš„æ¬Šé‡ã€‚æœ€å¾Œï¼Œå°‡é€™äº›æ¬Šé‡ï¼ˆğ‘Šâ‚, ğ‘Šâ‚‚, â€¦, ğ‘Šğ‘›ï¼‰èˆ‡ç‰¹å¾µåœ–ç›¸ä¹˜ï¼Œç„¶å¾Œé€²è¡Œç¸½å’Œï¼Œå°±å¯ä»¥è§€å¯Ÿåˆ°ä¸åŒä½ç½®å°è¼¸å‡ºçš„å½±éŸ¿ã€‚

![](./image/img22-7.png)

## CAM-Based æ–¹æ³•å¯¦ä½œ (Grad-CAM)
ä»Šå¤©çš„ç¯„ä¾‹å°‡ä½¿ç”¨ Xception é è¨“ç·´æ¨¡å‹ä¾†ç¤ºç¯„å¦‚ä½•é€é Grad-CAM è§£é‡‹æ¨¡å‹æ¨è«–çµæœã€‚Xception çš„åç¨±æ˜¯ç”± `Extreme Inception` è¡ç”Ÿè€Œä¾†ï¼Œå› ç‚ºå®ƒåŸºæ–¼ Inception v3 æ¶æ§‹çš„æ¦‚å¿µï¼Œä¸¦å°ä¸€äº›åœ°æ–¹é€²è¡Œäº†æ¥µç«¯æ“´å±•å’Œæ”¹é€²ã€‚

> Xception è«–æ–‡ï¼š[Xception: Deep Learning with Depthwise Separable Convolutions](https://arxiv.org/abs/1610.02357)


### è¼‰å…¥é è¨“ç·´æ¨¡å‹(Xception)
é¦–å…ˆä½¿ç”¨ TensorFlow è¼‰å…¥ Xception æ¨¡å‹ï¼Œå°‡è¼¸å…¥å¼µé‡(tensor)é€£æ¥åˆ°é è¨“ç·´çš„ç¥ç¶“ç¶²è·¯å±¤ï¼Œ`imagenet` è¡¨ç¤ºä½¿ç”¨åœ¨ ImageNet è³‡æ–™é›†ä¸Šé è¨“ç·´çš„æ¬Šé‡ã€‚`include_top=True` è¡¨ç¤ºè¼¸å‡ºåŒ…æ‹¬æ¨¡å‹çš„æœ€å¾Œåˆ†é¡å±¤(å…¨é€£æ¥å±¤)ï¼Œæ­¤æ¨¡å‹é€šå¸¸ç”¨æ–¼å½±åƒåˆ†é¡ä»»å‹™ã€‚

```py
from tensorflow.keras.applications.xception import Xception
from tensorflow.keras.layers import Input

# å»ºç«‹ä¸€å€‹è¼¸å…¥å¼µé‡ï¼ŒæŒ‡å®šåœ–åƒå¤§å°ç‚º224x224ï¼ˆRGBè‰²å½©é€šé“ï¼‰
input_tensor = Input(shape=(224, 224, 3))
# å»ºç«‹ Xception æ¨¡å‹
model = Xception(input_tensor=input_tensor, weights='imagenet', include_top=True)
```

æ¥è‘—è¼‰å…¥ä¸€å¼µåœ–åƒï¼Œå°å…¶é€²è¡Œé è™•ç†ã€‚å…¶ä¸­ `np.expand_dims()` çš„ç›®çš„æ˜¯å°‡åœ–åƒè½‰æ›ç‚ºæ¨¡å‹å¯æ¥å—çš„ç¶­åº¦ï¼Œé€™è£¡å°‡åœ–åƒåŒ…è£åœ¨ä¸€å€‹æ‰¹æ¬¡(batch)ä¸­ï¼Œé€šå¸¸æ˜¯ä¸€å€‹æ‰¹æ¬¡åªæœ‰ä¸€å¼µåœ–åƒã€‚æœ€å¾Œä½¿ç”¨ Xception æ¨¡å‹çš„é è™•ç†å‡½æ•¸ `preprocess_input()` ä¾†è™•ç†åœ–åƒï¼Œä»¥ç¢ºä¿åœ–åƒçš„æ•¸å€¼ç¯„åœå’Œæ ¼å¼ç¬¦åˆæ¨¡å‹çš„è¦æ±‚ã€‚

```py
import numpy as np
import tensorflow as tf
from tensorflow.keras.applications.xception import preprocess_input

# è¼‰å…¥åœ–åƒ
image = tf.keras.utils.load_img('./dataset/cat_dog.jpg')
image = tf.keras.utils.img_to_array(image) # å°‡è¼‰å…¥çš„åœ–åƒè½‰æ›ç‚ºæ•¸çµ„å½¢å¼
x = np.expand_dims(image.copy(), axis=0) # å°‡åœ–åƒè½‰æ›ç‚ºæ¨¡å‹å¯æ¥å—çš„ç¶­åº¦
# é è™•ç†åœ–åƒ
x = preprocess_input(x)
```

ç¢ºèªè¼¸å…¥å½±åƒéƒ½å®Œæˆè™•ç†éå¾Œï¼Œå°±å¯ä»¥ä½¿ç”¨å·²å»ºç«‹çš„ Xception æ¨¡å‹é€²è¡Œåœ–åƒåˆ†é¡é æ¸¬ï¼Œè¿”å›åˆ†é¡æ©Ÿç‡ã€‚æœ€å¾Œå†ä½¿ç”¨ `decode_predictions()` è§£æå–å¾—é æ¸¬çµæœï¼Œä¸¦å–å¾—é¡åˆ¥åç¨±å’Œç›¸å°æ‡‰çš„é æ¸¬æ©Ÿç‡ã€‚

```py
from tensorflow.keras.applications.xception import decode_predictions

# é€²è¡Œåœ–åƒåˆ†é¡é æ¸¬
pred_proba = model.predict(x) # è¿”å›åˆ†é¡æ©Ÿç‡
# è§£æé æ¸¬çµæœ
pred_class = decode_predictions(pred_proba, top=1)[0][0]  # è§£æå–å¾—é æ¸¬çµæœ
```

æˆ‘å€‘å…ˆä¾†çœ‹çœ‹æ¨¡å‹é æ¸¬çš„çµæœã€‚é›–ç„¶é€™å¼µå½±åƒåŒæ™‚æœ‰ä¸€éš»è²“å’Œç‹—ï¼Œä½†æ¨¡å‹åœ¨ç¥ç¶“ç¶²è·¯ä¸­å…ˆæŠ“å–åˆ°ç‹—çš„é‡è¦ç‰¹å¾µ(ä¾‹å¦‚ï¼šé¼»å­ã€å˜´å·´)ï¼Œå› æ­¤æœ€çµ‚æ¨¡å‹é æ¸¬ `bull_mastiff`(é¬¥ç‰›ç’)ï¼Œè©²é¡åˆ¥çš„æ©Ÿç‡å€¼æœ‰ 48%ã€‚

```py
import matplotlib.pylab as plt

plt.imshow(image.astype('uint8'))
plt.axis('off')
predicted_class_name = pred_class[1]
_ = plt.title(f"Prediction: {predicted_class_name} {pred_class[2]:.2f}")
```

![](./image/img22-8.png)

### Grad-CAM å¯¦ä½œ
é€™æ®µå‡½å¼ä¸»è¦ç”¨æ–¼ç”ŸæˆGrad-CAMç†±åœ–ï¼Œä»¥è¦–è¦ºåŒ–æ·±åº¦å­¸ç¿’æ¨¡å‹å°æ–¼è¼¸å…¥åœ–åƒçš„é æ¸¬çµæœçš„è§£é‡‹æ€§ã€‚é¦–å…ˆå»ºç«‹ä¸€å€‹æ–°çš„æ¨¡å‹ grad_modelï¼Œè©²æ¨¡å‹æ¥å—ç›¸åŒçš„è¼¸å…¥åœ–åƒï¼Œä½†åŒæ™‚è¼¸å‡ºæœ€å¾Œä¸€å€‹å·ç©å±¤çš„è¼¸å‡ºå’Œæ•´å€‹æ¨¡å‹çš„é æ¸¬çµæœã€‚é€™æ˜¯ç‚ºäº†èƒ½å¤ è¨ˆç®—ç‰¹å®šé¡åˆ¥å°æ–¼æœ€å¾Œä¸€å€‹å·ç©å±¤çš„æ¢¯åº¦ã€‚æ¥ä¸‹ä¾†ï¼Œä½¿ç”¨ TensorFlow çš„ GradientTape ä¾†è¨˜éŒ„è¨ˆç®—æ¢¯åº¦ã€‚å®ƒè¨ˆç®—äº†æ¨¡å‹å°æ–¼è¼¸å…¥åœ–åƒçš„é æ¸¬ï¼ŒåŒæ™‚è¨˜éŒ„äº†å°æ‡‰æ–¼ç‰¹å®šé¡åˆ¥çš„åˆ†é¡ç¥ç¶“å…ƒç›¸å°æ–¼æœ€å¾Œä¸€å€‹å·ç©å±¤è¼¸å‡ºçš„æ¢¯åº¦ã€‚ç„¶å¾Œè¨ˆç®—é€™äº›æ¢¯åº¦çš„å¹³å‡å¼·åº¦ pooled_gradsï¼Œä¸¦å–å¾—ä¸€å€‹å‘é‡åšç‚ºæ¬Šé‡ï¼Œæ¯å€‹å…ƒç´ å°æ‡‰æ–¼æœ€å¾Œä¸€å€‹å·ç©å±¤çš„ç‰¹å¾µåœ–é€šé“ã€‚æ¥è‘—å°‡æœ€å¾Œä¸€å€‹å·ç©å±¤çš„è¼¸å‡ºèˆ‡ pooled_grads åšé»ç©ï¼Œé€™å€‹æ“ä½œå¼·èª¿äº†å°æ–¼ç‰¹å®šé¡åˆ¥é æ¸¬é‡è¦çš„ç‰¹å¾µåœ–å€åŸŸã€‚å¾—åˆ°çš„çµæœæ˜¯ä¸€å€‹ç†±åœ–ï¼Œå…¶ä¸­æ¯å€‹åƒç´ å€¼è¡¨ç¤ºç›¸æ‡‰ä½ç½®å°æ–¼è©²é¡åˆ¥é æ¸¬çš„é‡è¦æ€§ã€‚æœ€å¾Œç‚ºäº†è¦–è¦ºåŒ–ï¼Œå°‡ç†±åœ–çš„å€¼æ­£è¦åŒ–ç‚ºä»‹æ–¼0å’Œ1ä¹‹é–“ï¼Œä»¥ä¾¿æ›´å®¹æ˜“ç†è§£å’Œè¦–è¦ºåŒ–ã€‚

```py
def make_gradcam_heatmap(img_array, model, last_conv_layer_name, pred_index=None):
    # å»ºç«‹ä¸€å€‹æ¨¡å‹ï¼ŒåŒæ™‚è¼¸å‡ºæœ€å¾Œä¸€å€‹å·ç©å±¤å’Œæ•´å€‹æ¨¡å‹çš„é æ¸¬çµæœ
    grad_model = tf.keras.models.Model(
        model.inputs, [model.get_layer(last_conv_layer_name).output, model.output]
    )
    
    # è¨ˆç®—å°æ–¼è¼¸å…¥åœ–åƒçš„é æ¸¬é¡åˆ¥ï¼Œç›¸å°æ–¼æœ€å¾Œä¸€å€‹å·ç©å±¤çš„æ¢¯åº¦
    with tf.GradientTape() as tape:
        last_conv_layer_output, preds = grad_model(img_array)
        if pred_index is None:
            pred_index = tf.argmax(preds[0])
        class_channel = preds[:, pred_index]

    # è¼¸å‡ºåˆ†é¡ç¥ç¶“å…ƒç›¸å°æ–¼æœ€å¾Œä¸€å€‹å·ç©å±¤çš„è¼¸å‡ºç‰¹å¾µåœ–çš„æ¢¯åº¦
    grads = tape.gradient(class_channel, last_conv_layer_output)

    # é€™æ˜¯ä¸€å€‹å‘é‡ï¼Œå…¶ä¸­æ¯å€‹æ•¸å­—éƒ½æ˜¯ç‰¹å®šç‰¹å¾µåœ–é€šé“ä¸Šçš„æ¢¯åº¦çš„å¹³å‡å¼·åº¦
    pooled_grads = tf.reduce_mean(grads, axis=(0, 1, 2))

    # å°‡ç‰¹å¾µåœ–ä¹˜ä»¥æ¬Šé‡ï¼Œç­‰æ–¼è©²ç‰¹å¾µåœ–ä¸­çš„æŸäº›å€åŸŸå°æ–¼è©²åˆ†é¡çš„é‡è¦æ€§
    last_conv_layer_output = last_conv_layer_output[0]
    heatmap = last_conv_layer_output @ pooled_grads[..., tf.newaxis]
    heatmap = tf.squeeze(heatmap) # ç„¶å¾Œå°‡æ‰€æœ‰é€šé“ç›¸åŠ ä»¥ç²å¾—ç†±åœ–

    # ç‚ºäº†è¦–è¦ºåŒ–ï¼Œå°‡ç†±åœ–æ­£è¦åŒ–0~1ä¹‹é–“
    heatmap = tf.maximum(heatmap, 0) / tf.math.reduce_max(heatmap)
    return heatmap.numpy()
```

æ¥ä¸‹ä¾†æˆ‘å€‘å¯¦éš›å°‡å½±åƒã€æ¨¡å‹ä»¥åŠæœ€å¾Œä¸€å±¤å·ç©çš„åç¨±é¤µå…¥æˆ‘å€‘å‰›å‰›å»ºç«‹çš„å‡½å¼ï¼Œç„¶å¾Œç¹ªè£½å‡ºä¸€å¼µç†±åœ–ã€‚åœ¨é€™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å€‘ä½¿ç”¨çš„æ˜¯ Xception æ¨¡å‹æ¶æ§‹ï¼Œå…¶æœ€å¾Œä¸€å±¤å·ç©å±¤çš„åç¨±ç‚º `block14_sepconv2_act`ã€‚å¦‚æœä¸çŸ¥é“æœ€å¾Œä¸€å±¤çš„åç¨±æ˜¯ä»€éº¼ï¼Œå¯ä»¥é€é `model.summary()` ä¾†æŸ¥çœ‹æ¨¡å‹çš„çµæ§‹ï¼Œç„¶å¾Œå°‹æ‰¾æœ€å¾Œä¸€å€‹ Conv2D å±¤çš„åç¨±ã€‚

![](./image/img22-9.png)

```py
# ç”¢ç”Ÿ class activation heatmap
last_conv_layer_name = "block14_sepconv2_act"
heatmap = make_gradcam_heatmap(x, model, last_conv_layer_name)

# é¡¯ç¤º heatmap
plt.matshow(heatmap)
plt.show()
```

ç”±æ–¼æœ€å¾Œä¸€å±¤çš„å·ç©ç‰¹å¾µåœ–å¤§å°ç‚º `(None, 7, 7, 2048)`ï¼Œå› æ­¤æœ€å¾Œè¨ˆç®—å‡ºä¾†çš„ç†±åœ–å¤§å°ç‚ºä¸€å¼µå°‡éæ­£è¦åŒ–çš„ `7*7` åƒç´ å¤§å°çš„ç†±åœ–ã€‚

![](./image/img22-10.png)

æœ€å¾Œé€™æ®µç¨‹å¼æ˜¯å°‡å‰›å‰›å¾—åˆ°çš„ç†±åœ–èˆ‡åŸå§‹å½±åƒé€²è¡Œç–Šåˆè¦–è¦ºåŒ–çµæœã€‚æ­¤å‡½å¼æ¥å—å››å€‹ä¸»è¦çš„è¼¸å…¥åƒæ•¸ï¼š

- img_path: è¼¸å…¥åœ–åƒçš„è·¯å¾‘ï¼Œé€™æ˜¯è¦è§£é‡‹çš„åœ–åƒã€‚
- heatmap: Grad-CAM ç†±åœ–ï¼Œè¡¨ç¤ºæ¨¡å‹å°åœ–åƒä¸­ä¸åŒå€åŸŸçš„é—œæ³¨ç¨‹åº¦ã€‚
- cam_path: è¼¸å‡ºçš„ç†±åœ–åœ–åƒæª”æ¡ˆçš„è·¯å¾‘ã€‚
- alpha: æ§åˆ¶ç–ŠåŠ ç†±åœ–å’ŒåŸå§‹åœ–åƒçš„é€æ˜åº¦ã€‚

```py
import matplotlib.cm as cm
from IPython.display import Image, display

def save_and_display_gradcam(img_path, heatmap, cam_path="cam.jpg", alpha=0.4):
    # è¼‰å…¥åŸå§‹åœ–åƒ
    img = tf.keras.utils.load_img(img_path)
    img = tf.keras.utils.img_to_array(img)

    # å°‡ç†±åœ–é‡æ–°ç¸®æ”¾åˆ°0-255çš„ç¯„åœ
    heatmap = np.uint8(255 * heatmap)

    # ä½¿ç”¨Jetè‰²å½©æ˜ å°„å°‡ç†±åœ–ä¸Šè‰²
    jet = cm.get_cmap("jet")

    # ä½¿ç”¨Jetè‰²å½©æ˜ å°„çš„RGBå€¼
    jet_colors = jet(np.arange(256))[:, :3]
    jet_heatmap = jet_colors[heatmap]

    # å‰µå»ºå¸¶æœ‰RGBè‰²å½©çš„ç†±åœ–åœ–åƒ
    jet_heatmap = tf.keras.utils.array_to_img(jet_heatmap)
    jet_heatmap = jet_heatmap.resize((img.shape[1], img.shape[0]))
    jet_heatmap = tf.keras.utils.img_to_array(jet_heatmap)

    # åœ¨åŸå§‹åœ–åƒä¸Šç–ŠåŠ ç†±åœ–
    superimposed_img = jet_heatmap * alpha + img
    superimposed_img = tf.keras.utils.array_to_img(superimposed_img)

    # å„²å­˜ç–ŠåŠ å¾Œçš„åœ–åƒ
    superimposed_img.save(cam_path)

    # é¡¯ç¤ºGrad CAM
    display(Image(cam_path))
```

```py
save_and_display_gradcam('./dataset/cat_dog.jpg', heatmap)
```

æœ€å¾Œæˆ‘å€‘å°±èƒ½å¾—åˆ°ä¸€å¼µå®Œæ•´çš„ Grad-CAM è§£é‡‹åœ–äº†ã€‚å¾åœ–ä¸­å¯å¾ˆæ˜é¡¯çŸ¥é“æ¨¡å‹è¾¨è­˜ä¸€éš»ç‹—æ˜¯é—œæ³¨å½±åƒä¸­çš„å“ªä¸€å€‹ç‰¹å¾µä½œç‚ºåˆ¤æ–·ä¾æ“šã€‚

![](./image/img22-11.png)

å¦‚æœæƒ³é€éç¬¬ä¸‰æ–¹å¥—ä»¶é€²è¡Œ CNN æ¨¡å‹è§£é‡‹ä¹Ÿå¯ä»¥ä½¿ç”¨ [tf_explain](https://github.com/sicara/tf-explain)ï¼Œå®ƒæ˜¯ä¸€å€‹é‡å° TensorFlow æ·±åº¦å­¸ç¿’æ¨¡å‹è§£é‡‹çš„ Python å¥—ä»¶ã€‚å…§å»ºæä¾›äº†å¤šç¨®æ–¹æ³•ï¼Œä¸¦é€éç†±åŠ›åœ–å¯ä»¥ç”¨ä¾†è§€å¯Ÿæ¨¡å‹æ˜¯å¦å­¸åˆ°é—œéµç‰¹å¾µã€‚

## Reference
- [Grad-CAM class activation visualization](https://keras.io/examples/vision/grad_cam/)